<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MatteMUD - Tester</title>
  <style>
    body {
      background: #0a0a0a;
      color: #00ff88;
      font-family: 'Courier New', monospace;
      padding: 20px;
      line-height: 1.6;
    }
    h1 { color: #00ff88; }
    .pass { color: #00ff88; }
    .fail { color: #ff5555; }
    .section { margin: 20px 0; padding: 10px; border-left: 3px solid #333; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>MatteMUD - Tester</h1>
  <div id="results"></div>

  <!-- Load game scripts -->
  <script src="../js/core/colors.js"></script>
  <script src="../js/core/Constants.js"></script>
  <script src="../js/core/Player.js"></script>
  <script src="../js/core/World.js"></script>
  <script src="../js/core/ChallengeGenerator.js"></script>
  <script src="../js/core/AnswerValidator.js"></script>
  <script src="../js/core/MathBeast.js"></script>
  <script src="../js/core/ChallengeSystem.js"></script>
  <script src="../js/core/BattleSystem.js"></script>
  <script src="../js/core/GameEngine.js"></script>
  <script src="../js/data/worldData.js"></script>

  <script>
    const results = document.getElementById('results');
    let passed = 0;
    let failed = 0;

    function log(text, className = '') {
      const div = document.createElement('div');
      div.className = className;
      div.textContent = text;
      results.appendChild(div);
    }

    function section(name) {
      const div = document.createElement('div');
      div.className = 'section';
      div.innerHTML = `<strong>üì¶ ${name}</strong>`;
      results.appendChild(div);
    }

    function test(name, fn) {
      try {
        fn();
        passed++;
        log(`  ‚úÖ ${name}`, 'pass');
      } catch (e) {
        failed++;
        log(`  ‚ùå ${name}: ${e.message}`, 'fail');
      }
    }

    function assertEqual(actual, expected) {
      if (actual !== expected) {
        throw new Error(`Expected ${expected}, got ${actual}`);
      }
    }

    function assertTrue(value) {
      if (!value) throw new Error(`Expected true, got ${value}`);
    }

    function assertFalse(value) {
      if (value) throw new Error(`Expected false, got ${value}`);
    }

    // Player Tests
    section('Player');

    test('skapar spelare med r√§tt startv√§rden', () => {
      const p = new Player('Test');
      assertEqual(p.name, 'Test');
      assertEqual(p.level, 1);
      assertEqual(p.xp, 0);
      assertEqual(p.hp, 100);
    });

    test('addXp returnerar true vid level up', () => {
      const p = new Player('Test');
      assertTrue(p.addXp(100));
      assertEqual(p.level, 2);
    });

    test('√∂kar maxHp vid level up', () => {
      const p = new Player('Test');
      p.addXp(100);
      assertEqual(p.maxHp, 110);
    });

    test('hasItem fungerar case-insensitive', () => {
      const p = new Player('Test');
      p.addItem('Gyllene Nyckel');
      assertTrue(p.hasItem('nyckel'));
      assertTrue(p.hasItem('GYLLENE'));
    });

    test('removeItem tar bort f√∂rem√•l', () => {
      const p = new Player('Test');
      p.addItem('Sv√§rd');
      assertTrue(p.removeItem('sv√§rd'));
      assertFalse(p.hasItem('sv√§rd'));
    });

    test('heal begr√§nsas av maxHp', () => {
      const p = new Player('Test');
      p.hp = 90;
      p.heal(50);
      assertEqual(p.hp, 100);
    });

    test('toJSON och fromJSON bevarar data', () => {
      const p = new Player('Hero');
      p.addXp(150);
      p.addItem('Potion');
      const loaded = Player.fromJSON(p.toJSON());
      assertEqual(loaded.name, 'Hero');
      assertEqual(loaded.xp, 150);
      assertTrue(loaded.hasItem('potion'));
    });

    // ChallengeGenerator Tests
    section('ChallengeGenerator');

    test('genererar MathProblem', () => {
      const gen = new ChallengeGenerator();
      const problem = gen.generate('addition', 1);
      assertTrue(problem instanceof MathProblem);
      assertTrue(problem.question.length > 0);
    });

    test('addition har r√§tt svar', () => {
      const gen = new ChallengeGenerator();
      for (let i = 0; i < 10; i++) {
        const p = gen.generate('addition', 1);
        const match = p.question.match(/(\d+)\s*\+\s*(\d+)/);
        if (match) {
          assertEqual(p.answer, String(parseInt(match[1]) + parseInt(match[2])));
        }
      }
    });

    test('multiplikation har r√§tt svar', () => {
      const gen = new ChallengeGenerator();
      for (let i = 0; i < 10; i++) {
        const p = gen.generate('multiplication', 1);
        const match = p.question.match(/(\d+)\s*√ó\s*(\d+)/);
        if (match) {
          assertEqual(p.answer, String(parseInt(match[1]) * parseInt(match[2])));
        }
      }
    });

    test('division utan rest har r√§tt svar', () => {
      const gen = new ChallengeGenerator();
      for (let i = 0; i < 10; i++) {
        const p = gen.generate('division', 1);
        const match = p.question.match(/(\d+)\s*√∑\s*(\d+)/);
        if (match) {
          assertEqual(p.answer, String(Math.floor(parseInt(match[1]) / parseInt(match[2]))));
        }
      }
    });

    // AnswerValidator Tests
    section('AnswerValidator');

    test('exakt match', () => {
      assertTrue(AnswerValidator.check('42', '42'));
    });

    test('whitespace-tolerant', () => {
      assertTrue(AnswerValidator.check(' 42 ', '42'));
    });

    test('komma som decimal', () => {
      assertTrue(AnswerValidator.check('3,5', '3.5'));
    });

    test('rest-format', () => {
      assertTrue(AnswerValidator.check('5 rest 2', '5 rest 2'));
      assertTrue(AnswerValidator.check('5rest2', '5 rest 2'));
    });

    test('procent-format', () => {
      assertTrue(AnswerValidator.check('50', '50%'));
      assertTrue(AnswerValidator.check('50%', '50%'));
    });

    test('fel svar returnerar false', () => {
      assertFalse(AnswerValidator.check('41', '42'));
    });

    // MathBeast Tests
    section('MathBeast');

    test('shouldAppear returnerar true efter 2 fel', () => {
      const mb = new MathBeast();
      assertFalse(mb.shouldAppear(1));
      assertTrue(mb.shouldAppear(2));
    });

    test('isActive √§r false initialt', () => {
      const mb = new MathBeast();
      assertFalse(mb.isActive());
    });

    test('appear aktiverar beast', () => {
      const mb = new MathBeast();
      const problem = new MathProblem({
        question: 'Test?',
        answer: '42',
        category: 'addition',
        difficulty: 1,
        methodExplanation: 'Test'
      });
      mb.appear(problem);
      assertTrue(mb.isActive());
    });

    // World Tests
    section('World');

    test('ladda rum fr√•n data', () => {
      const world = new World();
      world.loadFromData(WORLD_DATA);
      const room = world.getRoom('akademin_hall');
      assertTrue(room !== null);
      assertEqual(room.name, 'Trollkarlsakademins Hall');
    });

    test('getRoom returnerar null f√∂r ok√§nt id', () => {
      const world = new World();
      world.loadFromData(WORLD_DATA);
      assertEqual(world.getRoom('finns_inte'), null);
    });

    test('removeMonster tar bort monster', () => {
      const world = new World();
      world.loadFromData(WORLD_DATA);
      const room = world.getRoom('akademin_port');
      assertTrue(room.monster !== null);
      world.removeMonster('akademin_port');
      assertEqual(world.getRoom('akademin_port').monster, null);
    });

    test('markVisited och isVisited', () => {
      const world = new World();
      assertFalse(world.isVisited('akademin_hall'));
      world.markVisited('akademin_hall');
      assertTrue(world.isVisited('akademin_hall'));
    });

    // GameEngine Tests
    section('GameEngine');

    function createTestEngine() {
      const world = new World();
      world.loadFromData(WORLD_DATA);
      const player = new Player('Testare');
      const output = [];
      const engine = new GameEngine(world, player, {
        output: (text) => output.push(text),
      });
      return { engine, output, player, world };
    }

    test('kommandorouting: titta visar rum', () => {
      const { engine, output } = createTestEngine();
      engine.processCommand('titta');
      assertTrue(output.some(line => line.includes('Trollkarlsakademin')));
    });

    test('riktningsgenv√§gar: n/s/√∂/v', () => {
      const { engine, player, world } = createTestEngine();
      // Ta bort monster som blockerar i port-rummet
      // G√• √∂ster till √∂vningsrummet
      engine.processCommand('√∂');
      assertEqual(player.currentRoom, 'akademin_ovningsrum');
    });

    test('ok√§nt kommando visar hj√§lpmeddelande', () => {
      const { engine, output } = createTestEngine();
      engine.processCommand('xyzzy');
      assertTrue(output.some(line => line.includes('Vad sa du?')));
    });

    test('attack utan monster s√§ger lugnt l√§ge', () => {
      const { engine, output } = createTestEngine();
      engine.processCommand('attack');
      assertTrue(output.some(line => line.includes('Inga monster')));
    });

    test('l√∂s utan g√•ta s√§ger det', () => {
      const { engine, output } = createTestEngine();
      // akademin_hall har ingen challenge
      engine.processCommand('l√∂s');
      assertTrue(output.some(line => line.includes('ingen g√•ta')));
    });

    // ChallengeGenerator - extra tester
    section('ChallengeGenerator (extra)');

    test('ok√§nd kategori faller tillbaka till addition', () => {
      const gen = new ChallengeGenerator();
      const p = gen.generate('nonexistent', 1);
      assertTrue(p instanceof MathProblem);
      assertTrue(p.question.includes('+'));
    });

    test('subtraktion har r√§tt svar', () => {
      const gen = new ChallengeGenerator();
      for (let i = 0; i < 10; i++) {
        const p = gen.generate('subtraction', 1);
        const match = p.question.match(/(\d+)\s*-\s*(\d+)/);
        if (match) {
          assertEqual(p.answer, String(parseInt(match[1]) - parseInt(match[2])));
        }
      }
    });

    test('division med rest har korrekt format', () => {
      const gen = new ChallengeGenerator();
      for (let i = 0; i < 10; i++) {
        const p = gen.generate('division', 3);
        assertTrue(p.answer.includes('rest'));
        const match = p.answer.match(/(\d+) rest (\d+)/);
        assertTrue(match !== null);
      }
    });

    // Skuldsystem Tests
    section('Skuldsystem');

    test('addDebt och popDebt fungerar', () => {
      const p = new Player('Test');
      p.addDebt('addition', 1);
      assertTrue(p.hasDebt());
      const debt = p.popDebt();
      assertEqual(debt.category, 'addition');
      assertFalse(p.hasDebt());
    });

    test('skulder hanteras i FIFO-ordning', () => {
      const p = new Player('Test');
      p.addDebt('addition', 1);
      p.addDebt('subtraction', 2);
      assertEqual(p.popDebt().category, 'addition');
      assertEqual(p.popDebt().category, 'subtraction');
    });

    test('popDebt returnerar null utan skuld', () => {
      const p = new Player('Test');
      assertEqual(p.popDebt(), null);
    });

    // Timer Tests
    section('Timer');

    test('getTimerSeconds minskar med level', () => {
      const { engine } = createTestEngine();
      engine.player.level = 1;
      assertEqual(engine.battle.getTimerSeconds(), GameConstants.TIMER_SECONDS.EASY);
      engine.player.level = 5;
      assertEqual(engine.battle.getTimerSeconds(), GameConstants.TIMER_SECONDS.HARD);
      engine.player.level = 9;
      assertEqual(engine.battle.getTimerSeconds(), GameConstants.TIMER_SECONDS.EXPERT);
    });

    // Player findItem Tests
    section('Player findItem');

    test('findItem prioriterar exakt match', () => {
      const p = new Player('Test');
      p.addItem('Trolldryck');
      p.addItem('L√§kande dryck');
      const found = p.findItem('trolldryck');
      assertEqual(found, 'Trolldryck');
    });

    test('findItem hittar med startsWith', () => {
      const p = new Player('Test');
      p.addItem('L√§kande dryck');
      const found = p.findItem('l√§kande');
      assertEqual(found, 'L√§kande dryck');
    });

    test('findItem hittar med includes', () => {
      const p = new Player('Test');
      p.addItem('Gyllene Nyckel');
      const found = p.findItem('nyckel');
      assertEqual(found, 'Gyllene Nyckel');
    });

    // Constants Tests
    section('Constants');

    test('GameConstants finns och har korrekta v√§rden', () => {
      assertEqual(GameConstants.MAX_CALCULATORS, 3);
      assertEqual(GameConstants.MAX_DEBT_ATTEMPTS, 5);
      assertEqual(GameConstants.MATHBEAST_APPEAR_AFTER, 2);
      assertEqual(GameConstants.TIMER_SECONDS.EASY, 45);
    });

    // Summary
    const summary = document.createElement('div');
    summary.style.marginTop = '30px';
    summary.style.padding = '20px';
    summary.style.borderTop = '2px solid #333';
    summary.innerHTML = `
      <h2>Sammanfattning</h2>
      <p class="pass">‚úÖ Godk√§nda: ${passed}</p>
      <p class="fail">‚ùå Misslyckade: ${failed}</p>
      <p>${failed === 0 ? 'üéâ Alla tester godk√§nda!' : '‚ö†Ô∏è N√•gra tester misslyckades'}</p>
    `;
    results.appendChild(summary);
  </script>
</body>
</html>
